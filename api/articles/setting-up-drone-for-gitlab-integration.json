{"title":"配置 Drone 與 GitLab 整合","slug":"setting-up-drone-for-gitlab-integration","date":"2018-06-18T04:02:48.000Z","updated":"2021-09-05T09:19:44.597Z","comments":true,"path":"api/articles/setting-up-drone-for-gitlab-integration.json","excerpt":" [Figure] Drone 是一個以 Go 編寫、基於 Docker 的 CI/CD 平台。本篇文章簡單介紹 Drone 如何安裝與 GitLab 整合。","covers":["/2018/06/18/setting-up-drone-for-gitlab-integration/cover.png","/2018/06/18/setting-up-drone-for-gitlab-integration/add_new_application.png","/2018/06/18/setting-up-drone-for-gitlab-integration/authorize_drone.png","/2018/06/18/setting-up-drone-for-gitlab-integration/drone_example.png"],"content":"<p><img src=\"/2018/06/18/setting-up-drone-for-gitlab-integration/cover.png\"></p>\n<blockquote>\n<p>Drone 是一個以 Go 編寫、基於 Docker 的 CI/CD 平台。本篇文章簡單介紹 Drone 如何安裝與 GitLab 整合。</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h1 id=\"Prepare-Your-GitLab\"><a href=\"#Prepare-Your-GitLab\" class=\"headerlink\" title=\"Prepare Your GitLab\"></a>Prepare Your GitLab</h1><p>首先必須準備 GitLab 環境。依照需求，你可以選擇 <a href=\"https://about.gitlab.com/pricing/#self-hosted\">self-hosted</a> 或者 <a href=\"https://about.gitlab.com/pricing/#gitlab-com\">GitLab.com</a>。自行架設安裝 GitLab 的方式很多種，請參考<a href=\"https://about.gitlab.com/installation/\">官方說明</a>。如果你偏好使用 Docker，個人推薦使用 <a href=\"http://www.damagehead.com/docker-gitlab/\">docker-gitlab</a> 這個專案來快速安裝部署你的 GitLab 平台。</p>\n<p>準備好 GitLab 環境之後，你必須在 GitLab 上註冊應用程式取得 OAuth <code>client</code> 及 <code>secret</code>。假設你的 Drone Server 位置是 <code>http://YOUR_DRONE_HOST</code>，則 Callback URL 就填入 <code>http://YOUR_DRONE_HOST/authorize</code>。Scopes 選項記得要勾選 <code>api</code>，以取得足夠的 GitLab API 權限。</p>\n<p><img src=\"/2018/06/18/setting-up-drone-for-gitlab-integration/add_new_application.png\"></p>\n<h1 id=\"Install-Drone\"><a href=\"#Install-Drone\" class=\"headerlink\" title=\"Install Drone\"></a>Install Drone</h1><p>Drone 支持 GitLab 8.2 及更高版本。請確認已經安裝，<a href=\"https://www.docker.com/\">Docker</a> 以及 <a href=\"http://docs.docker.com/compose/\">Docker Compose</a>。編寫 <code>docker-compose.yml</code> 檔案並使用以下環境變量配置 Drone 容器。</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dts\"><span class=\"hljs-symbol\">version:</span> <span class=\"hljs-string\">&#x27;2&#x27;</span><br><br><span class=\"hljs-symbol\">services:</span><br>  drone-server:<br><span class=\"hljs-symbol\">    image:</span> drone/drone:<span class=\"hljs-number\">0.8</span><br><br><span class=\"hljs-symbol\">    ports:</span><br>      - <span class=\"hljs-number\">80</span>:<span class=\"hljs-number\">8000</span><br>      - <span class=\"hljs-number\">9000</span><br><span class=\"hljs-symbol\">    volumes:</span><br>      - <span class=\"hljs-meta-keyword\">/var/</span>lib/drone:<span class=\"hljs-meta-keyword\">/var/</span>lib<span class=\"hljs-meta-keyword\">/drone/</span><br><span class=\"hljs-symbol\">    restart:</span> always<br><span class=\"hljs-symbol\">    environment:</span><br>      - DRONE_GITLAB=true<br>      - DRONE_GITLAB_CLIENT=<span class=\"hljs-number\">95</span>c0282573633eb25e82<br>      - DRONE_GITLAB_SECRET=<span class=\"hljs-number\">30f</span>5064039e6b359e075<br>      - DRONE_GITLAB_URL=http:<span class=\"hljs-comment\">//gitlab.mycompany.com</span><br>      - DRONE_SECRET=$&#123;DRONE_SECRET&#125;<br><br>  drone-agent:<br><span class=\"hljs-symbol\">    image:</span> drone/agent:<span class=\"hljs-number\">0.8</span><br><br><span class=\"hljs-symbol\">    restart:</span> always<br><span class=\"hljs-symbol\">    depends_on:</span><br>      - drone-server<br><span class=\"hljs-symbol\">    volumes:</span><br>      - <span class=\"hljs-meta-keyword\">/var/</span>run/docker.sock:<span class=\"hljs-meta-keyword\">/var/</span>run/docker.sock<br><span class=\"hljs-symbol\">    environment:</span><br>      - DRONE_SERVER=drone-server:<span class=\"hljs-number\">9000</span><br>      - DRONE_SECRET=$&#123;DRONE_SECRET&#125;<br></code></pre></td></tr></table></figure>\n\n<p>將 GitLab 上取得的 <code>Application Id</code> 及 <code>Secret</code> 分別填入 <code>DRONE_GITLAB_CLIENT</code> 及 <code>DRONE_GITLAB_SECRET</code>。然後執行 <code>docker-compose up -d</code> 就啟動好 Drone 了。其他可選的環境變數選項請參考 <a href=\"http://docs.drone.io/install-for-gitlab/\">Drone 官方說明</a>。</p>\n<p>Drone 啟動完成後，進入 <code>http://YOUR_DRONE_HOST</code> 會要求 GitLab 取得授權。</p>\n<p><img src=\"/2018/06/18/setting-up-drone-for-gitlab-integration/authorize_drone.png\"></p>\n<p>取得授權後，接著會導向 <code>http://YOUR_DRONE_HOST/account/repos</code> 頁面，就可以選擇你要在 GitLab 下要整合 Drone 的專案。</p>\n<h1 id=\"Test-Your-Project\"><a href=\"#Test-Your-Project\" class=\"headerlink\" title=\"Test Your Project\"></a>Test Your Project</h1><p>以一個簡單的 Node.js 專案為例，我們在目錄下加入 <code>.drone.yml</code>：</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dts\"><span class=\"hljs-symbol\">pipeline:</span><br><span class=\"hljs-symbol\">  install:</span><br><span class=\"hljs-symbol\">    image:</span> node:<span class=\"hljs-number\">8</span><br><span class=\"hljs-symbol\">    commands:</span><br>      - npm install<br><span class=\"hljs-symbol\">  test:</span><br><span class=\"hljs-symbol\">    image:</span> node:<span class=\"hljs-number\">8</span><br><span class=\"hljs-symbol\">    commands:</span><br>      - npm test<br></code></pre></td></tr></table></figure>\n\n<p>這裡定義了兩個 pipeline，首先安裝依賴，然後執行測試。然後將專案 push 至 GitLab 即觸發 Drone 程序。關於 <code>.drone.yml</code> 設置的詳細說明請參考 <a href=\"http://docs.drone.io/pipelines/\">Drone 官方文件</a>。</p>\n<p><img src=\"/2018/06/18/setting-up-drone-for-gitlab-integration/drone_example.png\"></p>\n<p>OK，完成！</p>\n<h1 id=\"References\"><a href=\"#References\" class=\"headerlink\" title=\"References\"></a>References</h1><p><a href=\"https://about.gitlab.com/\">GitLab</a><br><a href=\"https://github.com/drone/drone\">Drone</a></p>\n","more":"<h1 id=\"Prepare-Your-GitLab\"><a href=\"#Prepare-Your-GitLab\" class=\"headerlink\" title=\"Prepare Your GitLab\"></a>Prepare Your GitLab</h1><p>首先必須準備 GitLab 環境。依照需求，你可以選擇 <a href=\"https://about.gitlab.com/pricing/#self-hosted\">self-hosted</a> 或者 <a href=\"https://about.gitlab.com/pricing/#gitlab-com\">GitLab.com</a>。自行架設安裝 GitLab 的方式很多種，請參考<a href=\"https://about.gitlab.com/installation/\">官方說明</a>。如果你偏好使用 Docker，個人推薦使用 <a href=\"http://www.damagehead.com/docker-gitlab/\">docker-gitlab</a> 這個專案來快速安裝部署你的 GitLab 平台。</p>\n<p>準備好 GitLab 環境之後，你必須在 GitLab 上註冊應用程式取得 OAuth <code>client</code> 及 <code>secret</code>。假設你的 Drone Server 位置是 <code>http://YOUR_DRONE_HOST</code>，則 Callback URL 就填入 <code>http://YOUR_DRONE_HOST/authorize</code>。Scopes 選項記得要勾選 <code>api</code>，以取得足夠的 GitLab API 權限。</p>\n<p><img src=\"/2018/06/18/setting-up-drone-for-gitlab-integration/add_new_application.png\"></p>\n<h1 id=\"Install-Drone\"><a href=\"#Install-Drone\" class=\"headerlink\" title=\"Install Drone\"></a>Install Drone</h1><p>Drone 支持 GitLab 8.2 及更高版本。請確認已經安裝，<a href=\"https://www.docker.com/\">Docker</a> 以及 <a href=\"http://docs.docker.com/compose/\">Docker Compose</a>。編寫 <code>docker-compose.yml</code> 檔案並使用以下環境變量配置 Drone 容器。</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dts\"><span class=\"hljs-symbol\">version:</span> <span class=\"hljs-string\">&#x27;2&#x27;</span><br><br><span class=\"hljs-symbol\">services:</span><br>  drone-server:<br><span class=\"hljs-symbol\">    image:</span> drone/drone:<span class=\"hljs-number\">0.8</span><br><br><span class=\"hljs-symbol\">    ports:</span><br>      - <span class=\"hljs-number\">80</span>:<span class=\"hljs-number\">8000</span><br>      - <span class=\"hljs-number\">9000</span><br><span class=\"hljs-symbol\">    volumes:</span><br>      - <span class=\"hljs-meta-keyword\">/var/</span>lib/drone:<span class=\"hljs-meta-keyword\">/var/</span>lib<span class=\"hljs-meta-keyword\">/drone/</span><br><span class=\"hljs-symbol\">    restart:</span> always<br><span class=\"hljs-symbol\">    environment:</span><br>      - DRONE_GITLAB=true<br>      - DRONE_GITLAB_CLIENT=<span class=\"hljs-number\">95</span>c0282573633eb25e82<br>      - DRONE_GITLAB_SECRET=<span class=\"hljs-number\">30f</span>5064039e6b359e075<br>      - DRONE_GITLAB_URL=http:<span class=\"hljs-comment\">//gitlab.mycompany.com</span><br>      - DRONE_SECRET=$&#123;DRONE_SECRET&#125;<br><br>  drone-agent:<br><span class=\"hljs-symbol\">    image:</span> drone/agent:<span class=\"hljs-number\">0.8</span><br><br><span class=\"hljs-symbol\">    restart:</span> always<br><span class=\"hljs-symbol\">    depends_on:</span><br>      - drone-server<br><span class=\"hljs-symbol\">    volumes:</span><br>      - <span class=\"hljs-meta-keyword\">/var/</span>run/docker.sock:<span class=\"hljs-meta-keyword\">/var/</span>run/docker.sock<br><span class=\"hljs-symbol\">    environment:</span><br>      - DRONE_SERVER=drone-server:<span class=\"hljs-number\">9000</span><br>      - DRONE_SECRET=$&#123;DRONE_SECRET&#125;<br></code></pre></td></tr></table></figure>\n\n<p>將 GitLab 上取得的 <code>Application Id</code> 及 <code>Secret</code> 分別填入 <code>DRONE_GITLAB_CLIENT</code> 及 <code>DRONE_GITLAB_SECRET</code>。然後執行 <code>docker-compose up -d</code> 就啟動好 Drone 了。其他可選的環境變數選項請參考 <a href=\"http://docs.drone.io/install-for-gitlab/\">Drone 官方說明</a>。</p>\n<p>Drone 啟動完成後，進入 <code>http://YOUR_DRONE_HOST</code> 會要求 GitLab 取得授權。</p>\n<p><img src=\"/2018/06/18/setting-up-drone-for-gitlab-integration/authorize_drone.png\"></p>\n<p>取得授權後，接著會導向 <code>http://YOUR_DRONE_HOST/account/repos</code> 頁面，就可以選擇你要在 GitLab 下要整合 Drone 的專案。</p>\n<h1 id=\"Test-Your-Project\"><a href=\"#Test-Your-Project\" class=\"headerlink\" title=\"Test Your Project\"></a>Test Your Project</h1><p>以一個簡單的 Node.js 專案為例，我們在目錄下加入 <code>.drone.yml</code>：</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dts\"><span class=\"hljs-symbol\">pipeline:</span><br><span class=\"hljs-symbol\">  install:</span><br><span class=\"hljs-symbol\">    image:</span> node:<span class=\"hljs-number\">8</span><br><span class=\"hljs-symbol\">    commands:</span><br>      - npm install<br><span class=\"hljs-symbol\">  test:</span><br><span class=\"hljs-symbol\">    image:</span> node:<span class=\"hljs-number\">8</span><br><span class=\"hljs-symbol\">    commands:</span><br>      - npm test<br></code></pre></td></tr></table></figure>\n\n<p>這裡定義了兩個 pipeline，首先安裝依賴，然後執行測試。然後將專案 push 至 GitLab 即觸發 Drone 程序。關於 <code>.drone.yml</code> 設置的詳細說明請參考 <a href=\"http://docs.drone.io/pipelines/\">Drone 官方文件</a>。</p>\n<p><img src=\"/2018/06/18/setting-up-drone-for-gitlab-integration/drone_example.png\"></p>\n<p>OK，完成！</p>\n<h1 id=\"References\"><a href=\"#References\" class=\"headerlink\" title=\"References\"></a>References</h1><p><a href=\"https://about.gitlab.com/\">GitLab</a><br><a href=\"https://github.com/drone/drone\">Drone</a></p>","categories":[{"name":"技術分享","path":"api/categories/技術分享.json"}],"tags":[{"name":"GitLab","path":"api/tags/GitLab.json"},{"name":"Docker","path":"api/tags/Docker.json"},{"name":"NodeJS","path":"api/tags/NodeJS.json"},{"name":"Git","path":"api/tags/Git.json"},{"name":"CI","path":"api/tags/CI.json"},{"name":"Drone","path":"api/tags/Drone.json"}]}