{"title":"使用 Passport 和 Node.js 的 POP3 身份認證策略","slug":"using-pop3-authentication-strategy-for-passport-and-nodejs","date":"2017-10-16T04:00:00.000Z","updated":"2021-09-05T09:19:32.642Z","comments":true,"path":"api/articles/using-pop3-authentication-strategy-for-passport-and-nodejs.json","excerpt":" [Figure] 通常學校或公司組織都會給予學生或在職員工一組 email 信箱，筆者以前在學校協助系上及實驗室寫內部系統的時候，經常會使用到 POP3 認證。使用 POP3 認證的好處是不需要讓使用者另外設定或記憶一組密碼，也易於與既有內部系統做整合。","covers":["/2017/10/16/using-pop3-authentication-strategy-for-passport-and-nodejs/cover.jpg"],"content":"<p><img src=\"/2017/10/16/using-pop3-authentication-strategy-for-passport-and-nodejs/cover.jpg\"></p>\n<blockquote>\n<p>通常學校或公司組織都會給予學生或在職員工一組 email 信箱，筆者以前在學校協助系上及實驗室寫內部系統的時候，經常會使用到 POP3 認證。使用 POP3 認證的好處是不需要讓使用者另外設定或記憶一組密碼，也易於與既有內部系統做整合。</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"Passport-POP3-Strategy\"><a href=\"#Passport-POP3-Strategy\" class=\"headerlink\" title=\"Passport POP3 Strategy\"></a>Passport POP3 Strategy</h2><p><a href=\"http://passportjs.org/\">Passport</a> 是實作 Node.js 應用程式認證機制常使用 Middleware。為了方便使用 POP3 authentication，我寫了一個 <a href=\"https://www.npmjs.com/package/passport-pop3\">passport-pop3</a> 的 Node.js 模組方便與 Passport 整合。</p>\n<h2 id=\"Install\"><a href=\"#Install\" class=\"headerlink\" title=\"Install\"></a>Install</h2><p>透過 <a href=\"https://www.npmjs.com/\">NPM</a> 下載安裝模組：</p>\n<figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ada\">$ npm install <span class=\"hljs-comment\">--save passport-pop3</span><br></code></pre></td></tr></table></figure>\n\n<p>或使用 <a href=\"https://yarnpkg.com/\">Yarn</a>：</p>\n<figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs elm\"><span class=\"hljs-title\">yarn</span> add pass<span class=\"hljs-keyword\">port</span>-pop3<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Usage\"><a href=\"#Usage\" class=\"headerlink\" title=\"Usage\"></a>Usage</h2><p>與其他 passport strategy 一樣，你需要將 <code>passport-pop3</code> strategy 整合至 passport，並提供 <code>host</code> 與 <code>port</code> 連線至你要認證的 POP3 Server：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs js\">passport.use(<span class=\"hljs-keyword\">new</span> POP3Strategy(&#123;<br>  host: <span class=\"hljs-string\">&#x27;localhost&#x27;</span>,<br>  port: <span class=\"hljs-number\">995</span><br>&#125;));<br></code></pre></td></tr></table></figure>\n\n<p>預設使用 SSL/TLS 安全連線，如果要關閉它請加入 <code>enabletls</code> 選項設為 <code>false</code>。</p>\n<p>如果你有使用過 <a href=\"https://github.com/jaredhanson/passport-local\">passport-local</a> 的經驗，應該會知道這個模組預設接收 <code>req.body</code> 的 <code>username</code> 與 <code>passport</code> 這兩個參數。我在 <code>passport-pop3</code> 的設定亦是，但也提供可修改設定的選項。如：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs js\">passport.use(<span class=\"hljs-keyword\">new</span> POP3Strategy(&#123;<br>  host: <span class=\"hljs-string\">&#x27;localhost&#x27;</span>,<br>  port: <span class=\"hljs-number\">110</span>,<br>  enabletls: <span class=\"hljs-literal\">false</span>,<br>  usernameField: <span class=\"hljs-string\">&#x27;email&#x27;</span>,<br>  passwordField: <span class=\"hljs-string\">&#x27;passwd&#x27;</span>,<br>&#125;));<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Example\"><a href=\"#Example\" class=\"headerlink\" title=\"Example\"></a>Example</h2><p>以 Gmail 為例，以下是一個比較完整的 <a href=\"http://expressjs.com/\">Express</a> 應用程式範例：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs js\"><span class=\"hljs-keyword\">const</span> express = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;express&#x27;</span>)<br><span class=\"hljs-keyword\">const</span> bodyParser = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;body-parser&#x27;</span>)<br><span class=\"hljs-keyword\">const</span> passport = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;passport&#x27;</span>)<br><span class=\"hljs-keyword\">const</span> POP3Strategy = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;passport-pop3&#x27;</span>)<br><br>passport.use(<span class=\"hljs-keyword\">new</span> POP3Strategy(&#123; <span class=\"hljs-attr\">host</span>: <span class=\"hljs-string\">&#x27;pop.gmail.com&#x27;</span>, <span class=\"hljs-attr\">port</span>: <span class=\"hljs-number\">995</span> &#125;))<br><br><span class=\"hljs-keyword\">const</span> app = express()<br><br>app.use(bodyParser.urlencoded(&#123; <span class=\"hljs-attr\">extended</span>: <span class=\"hljs-literal\">false</span> &#125;))<br>app.use(bodyParser.json())<br>app.use(passport.initialize())<br><br>app.post(<span class=\"hljs-string\">&#x27;/login&#x27;</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">req, res, next</span>) =&gt;</span> &#123;<br>  passport.authenticate(<span class=\"hljs-string\">&#x27;pop3&#x27;</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">err, user, info</span>) =&gt;</span> &#123;<br>    <span class=\"hljs-keyword\">if</span> (err) <span class=\"hljs-keyword\">return</span> res.status(<span class=\"hljs-number\">500</span>).send(<span class=\"hljs-string\">&#x27;Internal Server Error&#x27;</span>)<br>    <span class=\"hljs-keyword\">if</span> (!user) <span class=\"hljs-keyword\">return</span> res.status(<span class=\"hljs-number\">400</span>).send(<span class=\"hljs-string\">&#x27;Bad Request&#x27;</span>)<br>    <span class=\"hljs-keyword\">return</span> res.status(<span class=\"hljs-number\">200</span>).send(<span class=\"hljs-string\">&#x27;OK&#x27;</span>)<br>  &#125;)(req, res, next)<br>&#125;)<br><br>app.listen(<span class=\"hljs-number\">3000</span>, <span class=\"hljs-function\">() =&gt;</span> &#123;<br>  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">&#x27;Example app listening on port 3000!&#x27;</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>\n\n<p>如果使用上有任何問題及想法，歡迎 pull request 或者聯繫我。</p>\n","more":"<h2 id=\"Passport-POP3-Strategy\"><a href=\"#Passport-POP3-Strategy\" class=\"headerlink\" title=\"Passport POP3 Strategy\"></a>Passport POP3 Strategy</h2><p><a href=\"http://passportjs.org/\">Passport</a> 是實作 Node.js 應用程式認證機制常使用 Middleware。為了方便使用 POP3 authentication，我寫了一個 <a href=\"https://www.npmjs.com/package/passport-pop3\">passport-pop3</a> 的 Node.js 模組方便與 Passport 整合。</p>\n<h2 id=\"Install\"><a href=\"#Install\" class=\"headerlink\" title=\"Install\"></a>Install</h2><p>透過 <a href=\"https://www.npmjs.com/\">NPM</a> 下載安裝模組：</p>\n<figure class=\"highlight ada\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ada\">$ npm install <span class=\"hljs-comment\">--save passport-pop3</span><br></code></pre></td></tr></table></figure>\n\n<p>或使用 <a href=\"https://yarnpkg.com/\">Yarn</a>：</p>\n<figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs elm\"><span class=\"hljs-title\">yarn</span> add pass<span class=\"hljs-keyword\">port</span>-pop3<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Usage\"><a href=\"#Usage\" class=\"headerlink\" title=\"Usage\"></a>Usage</h2><p>與其他 passport strategy 一樣，你需要將 <code>passport-pop3</code> strategy 整合至 passport，並提供 <code>host</code> 與 <code>port</code> 連線至你要認證的 POP3 Server：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs js\">passport.use(<span class=\"hljs-keyword\">new</span> POP3Strategy(&#123;<br>  host: <span class=\"hljs-string\">&#x27;localhost&#x27;</span>,<br>  port: <span class=\"hljs-number\">995</span><br>&#125;));<br></code></pre></td></tr></table></figure>\n\n<p>預設使用 SSL/TLS 安全連線，如果要關閉它請加入 <code>enabletls</code> 選項設為 <code>false</code>。</p>\n<p>如果你有使用過 <a href=\"https://github.com/jaredhanson/passport-local\">passport-local</a> 的經驗，應該會知道這個模組預設接收 <code>req.body</code> 的 <code>username</code> 與 <code>passport</code> 這兩個參數。我在 <code>passport-pop3</code> 的設定亦是，但也提供可修改設定的選項。如：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs js\">passport.use(<span class=\"hljs-keyword\">new</span> POP3Strategy(&#123;<br>  host: <span class=\"hljs-string\">&#x27;localhost&#x27;</span>,<br>  port: <span class=\"hljs-number\">110</span>,<br>  enabletls: <span class=\"hljs-literal\">false</span>,<br>  usernameField: <span class=\"hljs-string\">&#x27;email&#x27;</span>,<br>  passwordField: <span class=\"hljs-string\">&#x27;passwd&#x27;</span>,<br>&#125;));<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Example\"><a href=\"#Example\" class=\"headerlink\" title=\"Example\"></a>Example</h2><p>以 Gmail 為例，以下是一個比較完整的 <a href=\"http://expressjs.com/\">Express</a> 應用程式範例：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs js\"><span class=\"hljs-keyword\">const</span> express = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;express&#x27;</span>)<br><span class=\"hljs-keyword\">const</span> bodyParser = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;body-parser&#x27;</span>)<br><span class=\"hljs-keyword\">const</span> passport = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;passport&#x27;</span>)<br><span class=\"hljs-keyword\">const</span> POP3Strategy = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;passport-pop3&#x27;</span>)<br><br>passport.use(<span class=\"hljs-keyword\">new</span> POP3Strategy(&#123; <span class=\"hljs-attr\">host</span>: <span class=\"hljs-string\">&#x27;pop.gmail.com&#x27;</span>, <span class=\"hljs-attr\">port</span>: <span class=\"hljs-number\">995</span> &#125;))<br><br><span class=\"hljs-keyword\">const</span> app = express()<br><br>app.use(bodyParser.urlencoded(&#123; <span class=\"hljs-attr\">extended</span>: <span class=\"hljs-literal\">false</span> &#125;))<br>app.use(bodyParser.json())<br>app.use(passport.initialize())<br><br>app.post(<span class=\"hljs-string\">&#x27;/login&#x27;</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">req, res, next</span>) =&gt;</span> &#123;<br>  passport.authenticate(<span class=\"hljs-string\">&#x27;pop3&#x27;</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">err, user, info</span>) =&gt;</span> &#123;<br>    <span class=\"hljs-keyword\">if</span> (err) <span class=\"hljs-keyword\">return</span> res.status(<span class=\"hljs-number\">500</span>).send(<span class=\"hljs-string\">&#x27;Internal Server Error&#x27;</span>)<br>    <span class=\"hljs-keyword\">if</span> (!user) <span class=\"hljs-keyword\">return</span> res.status(<span class=\"hljs-number\">400</span>).send(<span class=\"hljs-string\">&#x27;Bad Request&#x27;</span>)<br>    <span class=\"hljs-keyword\">return</span> res.status(<span class=\"hljs-number\">200</span>).send(<span class=\"hljs-string\">&#x27;OK&#x27;</span>)<br>  &#125;)(req, res, next)<br>&#125;)<br><br>app.listen(<span class=\"hljs-number\">3000</span>, <span class=\"hljs-function\">() =&gt;</span> &#123;<br>  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">&#x27;Example app listening on port 3000!&#x27;</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>\n\n<p>如果使用上有任何問題及想法，歡迎 pull request 或者聯繫我。</p>","categories":[{"name":"技術分享","path":"api/categories/技術分享.json"}],"tags":[{"name":"NodeJS","path":"api/tags/NodeJS.json"},{"name":"Passport","path":"api/tags/Passport.json"},{"name":"POP3","path":"api/tags/POP3.json"},{"name":"Authentication","path":"api/tags/Authentication.json"}]}