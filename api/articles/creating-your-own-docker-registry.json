{"title":"建立自己的 Docker Registry","slug":"creating-your-own-docker-registry","date":"2017-05-24T09:13:03.000Z","updated":"2021-09-05T09:19:18.836Z","comments":true,"path":"api/articles/creating-your-own-docker-registry.json","excerpt":" [Figure] Docker Hub 是 Docker 官方維護的公共倉庫。但是如果映像檔 (image) 不便公開，可能就不適合使用公共倉庫，這時候我們就需要 Docker Registry 來建立自己的私有倉庫。","covers":["/2017/05/24/creating-your-own-docker-registry/cover.jpg","/2017/05/24/creating-your-docker-registry/docker_for_mac.png"],"content":"<p><img src=\"/2017/05/24/creating-your-own-docker-registry/cover.jpg\"></p>\n<blockquote>\n<p><a href=\"https://hub.docker.com/\">Docker Hub</a> 是 <a href=\"https://www.docker.com/\">Docker</a> 官方維護的公共倉庫。但是如果映像檔 (image) 不便公開，可能就不適合使用公共倉庫，這時候我們就需要 <a href=\"https://docs.docker.com/registry/\">Docker Registry</a> 來建立自己的私有倉庫。</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"Install-Docker-Registry\"><a href=\"#Install-Docker-Registry\" class=\"headerlink\" title=\"Install Docker Registry\"></a>Install Docker Registry</h2><p>登入欲建立 Docker Registry 的遠端 Server，從 Docker Hub 拉取 Docker Registry 映像檔並啟動： </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo docker run -d -p 5000:5000 --restart=always --name registry registry:2<br></code></pre></td></tr></table></figure>\n\n<p>這樣我們就已經在遠端 Server 上安裝好 Docker Registry 。</p>\n<h2 id=\"Install-Docker-Registry-Frontend-Optional\"><a href=\"#Install-Docker-Registry-Frontend-Optional\" class=\"headerlink\" title=\"Install Docker Registry Frontend (Optional)\"></a>Install Docker Registry Frontend (Optional)</h2><p>目前已有許多第三方為 Docker Registry 實現的 Web UI 介面，方便瀏覽在 registry 上的 images 。綜合目前在 Docker Hub 與 GitHub 上的 stars 數量，比較多人使用的是這套 <a href=\"https://hub.docker.com/r/konradkleine/docker-registry-frontend\">Docker Registry Frontend</a> ，以 AngularJS 開發的 UI 介面。其安裝方式也相當簡單：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">sudo docker run \\<br>  -d \\<br>  -e ENV_DOCKER_REGISTRY_HOST=ENTER-YOUR-REGISTRY-HOST-HERE \\<br>  -e ENV_DOCKER_REGISTRY_PORT=ENTER-PORT-TO-YOUR-REGISTRY-HOST-HERE \\<br>  -p 8080:80 \\<br>  konradkleine/docker-registry-frontend:v2<br></code></pre></td></tr></table></figure>\n\n<p>完成啟動後，您可以打開瀏覽器進入 <code>http://localhost:8080</code> 查看 registry 狀態。</p>\n<h2 id=\"Setup-for-Insecure-Registry\"><a href=\"#Setup-for-Insecure-Registry\" class=\"headerlink\" title=\"Setup for Insecure Registry\"></a>Setup for Insecure Registry</h2><p>以下 IP <code>xxx.xxx.xxx.xxx</code> 表示我們遠端伺服器安裝 Docker Registry 的所在位址。</p>\n<p>因為我們遠端的 Docker Registry 並沒有安裝 certificate，因此必須在本地 <code>/etc/default/docker</code> 加入：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">DOCKER_OPTS</span>=<span class=\"hljs-string\">&quot;$DOCKER_OPTS --insecure-registry=xxx.xxx.xxx.xxx:5000&quot;</span><br></code></pre></td></tr></table></figure>\n\n<p>然後重啟 Docker 服務：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo service docker restart<br></code></pre></td></tr></table></figure>\n\n<p>如果您使用 <strong>Docker for Mac</strong> ，打開應用程式找到 Preferences：</p>\n<p><img src=\"/2017/05/24/creating-your-docker-registry/docker_for_mac.png\"></p>\n<p>在 <code>Insecure registries</code> 列表加入 registry 位址，然後按下 <code>Apply &amp; Restart</code> 等待 Docker 重啟完畢就可以了。</p>\n<h2 id=\"Test-Your-Docker-Registry\"><a href=\"#Test-Your-Docker-Registry\" class=\"headerlink\" title=\"Test Your Docker Registry\"></a>Test Your Docker Registry</h2><p>為了測試我們建立的 Docker Registry ，我們需要從 Docker Hub 上 pull 一個 image 或自行建立 image 來做測試。此處範例我們在本地端從 Docker Hub 下載一個 <code>ubuntu</code> 映像檔：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo docker pull ubuntu<br></code></pre></td></tr></table></figure>\n\n<p>將下載後的映像檔 tag 指向我們所建立的 registry ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo docker tag ubuntu xxx.xxx.xxx.xxx:5000/ubuntu<br></code></pre></td></tr></table></figure>\n\n<p>上傳 image 至 自建 registry ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo docker push xxx.xxx.xxx.xxx:5000/ubuntu<br></code></pre></td></tr></table></figure>\n\n<p>從自建 registry 下載 image ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo docker pull xxx.xxx.xxx.xxx:5000/ubuntu<br></code></pre></td></tr></table></figure>\n\n<p>Docker Registry 也提供 HTTP API，例如查看 registry 上的 repositories ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ curl http://xxx.xxx.xxx.xxx:5000/v2/_catalog <br></code></pre></td></tr></table></figure>\n\n<p>確認某個 image 的 tag ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ curl http://xxx.xxx.xxx.xxx:5000/v2/SOME_IMAGE/tags/list <br></code></pre></td></tr></table></figure>\n\n<p>更多關於 Docker Registry 的其他用法可參閱<a href=\"https://docs.docker.com/registry\">官方文件</a> 。</p>\n","more":"<h2 id=\"Install-Docker-Registry\"><a href=\"#Install-Docker-Registry\" class=\"headerlink\" title=\"Install Docker Registry\"></a>Install Docker Registry</h2><p>登入欲建立 Docker Registry 的遠端 Server，從 Docker Hub 拉取 Docker Registry 映像檔並啟動： </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo docker run -d -p 5000:5000 --restart=always --name registry registry:2<br></code></pre></td></tr></table></figure>\n\n<p>這樣我們就已經在遠端 Server 上安裝好 Docker Registry 。</p>\n<h2 id=\"Install-Docker-Registry-Frontend-Optional\"><a href=\"#Install-Docker-Registry-Frontend-Optional\" class=\"headerlink\" title=\"Install Docker Registry Frontend (Optional)\"></a>Install Docker Registry Frontend (Optional)</h2><p>目前已有許多第三方為 Docker Registry 實現的 Web UI 介面，方便瀏覽在 registry 上的 images 。綜合目前在 Docker Hub 與 GitHub 上的 stars 數量，比較多人使用的是這套 <a href=\"https://hub.docker.com/r/konradkleine/docker-registry-frontend\">Docker Registry Frontend</a> ，以 AngularJS 開發的 UI 介面。其安裝方式也相當簡單：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">sudo docker run \\<br>  -d \\<br>  -e ENV_DOCKER_REGISTRY_HOST=ENTER-YOUR-REGISTRY-HOST-HERE \\<br>  -e ENV_DOCKER_REGISTRY_PORT=ENTER-PORT-TO-YOUR-REGISTRY-HOST-HERE \\<br>  -p 8080:80 \\<br>  konradkleine/docker-registry-frontend:v2<br></code></pre></td></tr></table></figure>\n\n<p>完成啟動後，您可以打開瀏覽器進入 <code>http://localhost:8080</code> 查看 registry 狀態。</p>\n<h2 id=\"Setup-for-Insecure-Registry\"><a href=\"#Setup-for-Insecure-Registry\" class=\"headerlink\" title=\"Setup for Insecure Registry\"></a>Setup for Insecure Registry</h2><p>以下 IP <code>xxx.xxx.xxx.xxx</code> 表示我們遠端伺服器安裝 Docker Registry 的所在位址。</p>\n<p>因為我們遠端的 Docker Registry 並沒有安裝 certificate，因此必須在本地 <code>/etc/default/docker</code> 加入：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">DOCKER_OPTS</span>=<span class=\"hljs-string\">&quot;$DOCKER_OPTS --insecure-registry=xxx.xxx.xxx.xxx:5000&quot;</span><br></code></pre></td></tr></table></figure>\n\n<p>然後重啟 Docker 服務：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo service docker restart<br></code></pre></td></tr></table></figure>\n\n<p>如果您使用 <strong>Docker for Mac</strong> ，打開應用程式找到 Preferences：</p>\n<p><img src=\"/2017/05/24/creating-your-docker-registry/docker_for_mac.png\"></p>\n<p>在 <code>Insecure registries</code> 列表加入 registry 位址，然後按下 <code>Apply &amp; Restart</code> 等待 Docker 重啟完畢就可以了。</p>\n<h2 id=\"Test-Your-Docker-Registry\"><a href=\"#Test-Your-Docker-Registry\" class=\"headerlink\" title=\"Test Your Docker Registry\"></a>Test Your Docker Registry</h2><p>為了測試我們建立的 Docker Registry ，我們需要從 Docker Hub 上 pull 一個 image 或自行建立 image 來做測試。此處範例我們在本地端從 Docker Hub 下載一個 <code>ubuntu</code> 映像檔：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo docker pull ubuntu<br></code></pre></td></tr></table></figure>\n\n<p>將下載後的映像檔 tag 指向我們所建立的 registry ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo docker tag ubuntu xxx.xxx.xxx.xxx:5000/ubuntu<br></code></pre></td></tr></table></figure>\n\n<p>上傳 image 至 自建 registry ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo docker push xxx.xxx.xxx.xxx:5000/ubuntu<br></code></pre></td></tr></table></figure>\n\n<p>從自建 registry 下載 image ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ sudo docker pull xxx.xxx.xxx.xxx:5000/ubuntu<br></code></pre></td></tr></table></figure>\n\n<p>Docker Registry 也提供 HTTP API，例如查看 registry 上的 repositories ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ curl http://xxx.xxx.xxx.xxx:5000/v2/_catalog <br></code></pre></td></tr></table></figure>\n\n<p>確認某個 image 的 tag ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ curl http://xxx.xxx.xxx.xxx:5000/v2/SOME_IMAGE/tags/list <br></code></pre></td></tr></table></figure>\n\n<p>更多關於 Docker Registry 的其他用法可參閱<a href=\"https://docs.docker.com/registry\">官方文件</a> 。</p>","categories":[{"name":"技術分享","path":"api/categories/技術分享.json"}],"tags":[{"name":"Docker","path":"api/tags/Docker.json"},{"name":"DevOps","path":"api/tags/DevOps.json"},{"name":"Docker Registry","path":"api/tags/Docker Registry.json"}]}